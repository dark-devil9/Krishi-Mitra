<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agroculture</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: linear-gradient(135deg, #e8f5e9 0%, #e3f2fd 50%, #f3e8ff 100%);
      --glass: rgba(255,255,255,0.56);
      --border: rgba(0,0,0,0.08);
      --shadow: 0 10px 25px rgba(16,24,40,.08);
      --brand: #16a34a;
      --brand-ink: #0f5132;
    }
    body { background: var(--bg); font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; }
    .app-shell { min-height: 100vh; }
    .navbar-brand { font-weight: 700; letter-spacing:.2px; }
    .brand-icon { width:28px; height:28px; border-radius:50%; display:inline-grid; place-items:center; background:#e8ffe8; color:var(--brand-ink); margin-right:8px; }
    .glass { background: var(--glass); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border:1px solid var(--border); box-shadow: var(--shadow); }
    .card { border-radius: 14px; }
    .panel-title { font-weight:600; letter-spacing:.2px; }
    .small-muted { font-size:12px; color:#6b7280; }
    .split { display:grid; grid-template-columns: 1fr 1.4fr; gap:16px; }
    @media (max-width: 992px) { .split { grid-template-columns: 1fr; } }

    /* Chat */
    .chat-box { height: 470px; overflow-y:auto; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:14px; box-shadow: var(--shadow); }
    .msg { margin-bottom:12px; display:flex; gap:10px; align-items:flex-end; }
    .msg.me { justify-content:flex-end; }
    .avatar { width:32px; height:32px; border-radius:50%; display:grid; place-items:center; background:#eef2ff; color:#3730a3; font-size:16px; box-shadow: 0 2px 6px rgba(0,0,0,.06); }
    .msg.me .avatar { background:#dcfce7; color:#166534; }
    .msg .bubble { padding:10px 12px; border-radius:14px; max-width:72%; line-height:1.45; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    .msg.me .bubble { background:#dcfce7; }
    .msg.bot .bubble { background:#eef2ff; }
    .bubble .btn { padding:3px 8px; font-size:12px; }
    .chat-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .recording-dot { width:8px; height:8px; background:#ef4444; border-radius:50%; display:inline-block; margin-left:8px; box-shadow:0 0 0 0 rgba(239,68,68, .7); animation:pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow:0 0 0 0 rgba(239,68,68, .7);} 70% { box-shadow:0 0 0 12px rgba(239,68,68, 0);} 100% { box-shadow:0 0 0 0 rgba(239,68,68, 0);} }

    /* Lists */
    .list-clean > div { border:1px dashed #e5e7eb; border-radius:10px; padding:10px 12px; background:#fff; }
    .list-clean > div .badge { font-weight:500; }
    .suggestion-card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; box-shadow: var(--shadow); }
    /* Multi-line clamp utility */
    /* Removed clamp to show full suggestions */

    /* Hero/banner */
    .hero { background: var(--glass); border:1px solid var(--border); box-shadow: var(--shadow); border-radius:16px; overflow:hidden; }
    .hero .bg { background: radial-gradient(1200px 300px at 10% -10%, rgba(22,163,74,.15), transparent), radial-gradient(1200px 300px at 90% -10%, rgba(59,130,246,.15), transparent); height: 80px; }
    .hero .content { padding: 14px 16px; }

    /* Dark mode */
    .dark body, body.dark { background: #0b1020; }
    body.dark .glass { background: rgba(17,24,39,.55); border-color: rgba(255,255,255,.06); }
    body.dark .chat-box { background:#0f172a; border-color: rgba(255,255,255,.08); }
    body.dark .msg.bot .bubble { background:#111827; color:#e5e7eb; }
    body.dark .msg.me .bubble { background:#064e3b; color:#e5e7eb; }
    body.dark .small-muted { color:#94a3b8; }
    body.dark .navbar { background: rgba(15,23,42,.6) !important; }
    body.dark .card { background: rgba(15,23,42,.6); }
    .btn-glass { background: rgba(255,255,255,.5); border:1px solid var(--border); }
    body.dark .btn-glass { background: rgba(255,255,255,.08); color:#e5e7eb; border-color: rgba(255,255,255,.06); }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-white glass sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <span class="brand-icon"><i class="fa-solid fa-seedling"></i></span>
      Agroculture
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navBar" aria-controls="navBar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navBar">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="#appView">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="#chatBox">Chat</a></li>
        <li class="nav-item"><a class="nav-link" href="#alertsBox">Alerts</a></li>
        <li class="nav-item">
          <button id="themeToggle" class="btn btn-sm btn-glass ms-2" title="Toggle theme"><i class="fa-regular fa-moon"></i></button>
        </li>
      </ul>
    </div>
  </div>
  </nav>

<div class="container py-4 app-shell">
  <h2 class="mb-3 text-center visually-hidden">ðŸŒ¾ Agroculture</h2>

  <!-- Hero Banner -->
  <div class="hero mb-3 glass">
    <div class="bg"></div>
    <div class="content d-flex align-items-center justify-content-between flex-wrap">
      <div>
        <div class="h5 mb-1">Welcome to Agroculture</div>
        <div class="small-muted">Smart, location-aware market prices, weather alerts and advisoryâ€”now with voice.</div>
      </div>
      <div class="d-flex gap-2 mt-2 mt-md-0">
        <a href="#chatBox" class="btn btn-success"><i class="fa-solid fa-comments"></i> Start Chat</a>
        <a href="#alertsBox" class="btn btn-outline-success">View Alerts</a>
      </div>
    </div>
  </div>

  <!-- ================= AUTH (client-side) ================= -->
  <div id="authView" class="row justify-content-center">
    <div class="col-md-7">
      <div class="card shadow-sm glass">
        <div class="card-body">
          <h5 class="card-title mb-3">Login or Sign up</h5>
          <p class="small-muted mb-3">
            Weâ€™ll create a secure internal <code>user_id</code> for this device and keep it hidden. Your profile is completed via onboarding and stored by your backend through <code>/chat</code>.
          </p>
          <form id="authForm" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="email" placeholder="you@example.com" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
            </div>
            <div class="col-12">
              <button class="btn btn-primary">Continue</button>
              <span class="small-muted ms-2">No backend auth endpoints are requiredâ€”this only creates a local session + hidden user_id.</span>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= ONBOARDING ================= -->
  <div id="onboardingView" class="row justify-content-center" style="display:none;">
    <div class="col-lg-9">
      <div class="card shadow-sm glass">
        <div class="card-body">
          <h5 class="card-title mb-3">Complete your profile</h5>
          <form id="onboardForm" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-control" id="ob_name" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Land Size (acres)</label>
              <input type="text" class="form-control" id="ob_land" placeholder="e.g., 5 acres or NA" required />
            </div>
            <div class="col-12">
              <label class="form-label">Location (Describe)</label>
              <textarea class="form-control" id="ob_location" rows="2" placeholder="Village/Town, Tehsil, District, State" required></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">Pincode</label>
              <input type="text" class="form-control" id="ob_pin" inputmode="numeric" pattern="[0-9]{6}" placeholder="6 digits" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">State</label>
              <input type="text" class="form-control" id="ob_state" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">District</label>
              <input type="text" class="form-control" id="ob_district" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Budget (â‚¹, numbers only)</label>
              <input type="number" class="form-control" id="ob_budget" placeholder="e.g., 500000" required />
            </div>
            <div class="col-md-6">
              <label class="form-label d-block">Gender</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="ob_gender" id="g_m" value="Male" checked>
                <label class="form-check-label" for="g_m">Male</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="ob_gender" id="g_f" value="Female">
                <label class="form-check-label" for="g_f">Female</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="ob_gender" id="g_o" value="Other">
                <label class="form-check-label" for="g_o">Other</label>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-control" id="ob_dob" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Current Crops (optional)</label>
              <input type="text" class="form-control" id="ob_crops" placeholder="e.g., Wheat, Mustard" />
            </div>
            <div class="col-12">
              <button class="btn btn-success">Save & Continue</button>
              <span class="small-muted ms-2">This submits your details into your backendâ€™s onboarding stages via <code>/chat</code>.</span>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= DASHBOARD ================= -->
  <div id="appView" style="display:none;">
    <div class="split">
      <!-- Left: Alerts + Suggestions -->
      <div>
        <div class="card mb-3 shadow-sm glass">
          <div class="card-body">
            <div class="panel-title mb-2">Alerts</div>
            <div id="alertsBox" class="vstack gap-2 list-clean">
              <div class="text-muted">Loading alertsâ€¦</div>
            </div>
          </div>
        </div>
        <div class="card shadow-sm glass">
          <div class="card-body">
            <div class="panel-title mb-2">Suggestions</div>
            <div id="suggBox" class="vstack gap-2">
              <div class="text-muted">Loading suggestionsâ€¦</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Chat -->
      <div>
        <div class="card shadow-sm glass">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="panel-title">Chatbot</div>
              <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">Logout</button>
            </div>
            <div id="chatBox" class="chat-box mb-2"></div>
            <form id="chatForm" class="d-flex gap-2 align-items-center flex-wrap">
              <button type="button" id="recBtn" class="btn btn-outline-secondary" title="Hold to record"><i class="fa-solid fa-microphone"></i></button>
              <div id="recDot" class="small-muted" style="display:none;">Recording <span class="recording-dot"></span></div>
              <div class="btn-group ms-1" role="group" aria-label="Voice language">
                <button type="button" id="voiceLangEn" class="btn btn-sm btn-outline-primary active">EN</button>
                <button type="button" id="voiceLangHi" class="btn btn-sm btn-outline-primary">à¤¹à¤¿à¤‚</button>
              </div>
              <input id="chatInput" class="form-control" placeholder="Ask anything about agricultureâ€¦" />
              <button class="btn btn-primary">Send</button>
            </form>
            <div class="small-muted mt-2">Answers are powered by your backend <code>/ask</code> using your trained RAG.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="mt-4">
    <div class="card glass">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div class="small-muted">Â© <span id="yr"></span> Agroculture. All rights reserved.</div>
        <div class="d-flex gap-3 small-muted">
          <a href="#" class="text-decoration-none">Privacy</a>
          <a href="#" class="text-decoration-none">Terms</a>
          <a href="#" class="text-decoration-none">Contact</a>
        </div>
      </div>
    </div>
  </footer>

</div>

<script>
  // ================== CONFIG ==================
  const BACKEND_BASE = "http://127.0.0.1:8000"; // change if needed

  // ================== SESSION / USER ID ==================
  function getOrCreateUserId() {
    let uid = localStorage.getItem("km_user_id");
    if (!uid) {
      uid = crypto.randomUUID();
      localStorage.setItem("km_user_id", uid);
    }
    return uid;
  }
  function clearSession() {
    localStorage.removeItem("km_user_id");
    localStorage.removeItem("km_name");
  }

  let USER_ID = getOrCreateUserId();

  // ================== VIEW HELPERS ==================
  function show(id, on=true) {
    document.getElementById(id).style.display = on ? "" : "none";
  }
  function toast(msg) { alert(msg); } // simple
  // Theme toggle
  const toggleBtn = document.getElementById('themeToggle');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', ()=>{
      document.body.classList.toggle('dark');
    });
  }

  // ================== AUTH (client-side only) ==================
  document.getElementById("authForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    // Create local session; donâ€™t show user_id
    USER_ID = getOrCreateUserId();
    // Check if backend already has profile
    const st = await fetch(`${BACKEND_BASE}/status?user_id=${encodeURIComponent(USER_ID)}`).then(r=>r.json()).catch(()=>({status:"new_user"}));
    if (st.status === "profile_complete" || st.status === "completed" || st.status === "profile_complete") {
      show("authView", false);
      show("appView", true);
      initDashboard();
    } else {
      show("authView", false);
      show("onboardingView", true);
    }
  });

  // ================== ONBOARDING ==================
  document.getElementById("onboardForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const name = document.getElementById("ob_name").value.trim();
    const land = document.getElementById("ob_land").value.trim();
    const loc  = document.getElementById("ob_location").value.trim();
    const pin  = document.getElementById("ob_pin").value.trim();
    const state= document.getElementById("ob_state").value.trim();
    const dist = document.getElementById("ob_district").value.trim();
    const budget = document.getElementById("ob_budget").value.trim();
    const gender = document.querySelector("input[name='ob_gender']:checked").value;
    const dob = document.getElementById("ob_dob").value;
    const crops = document.getElementById("ob_crops").value.trim();

    localStorage.setItem("km_name", name);

    // The backendâ€™s /chat is a stage machine. We drive it in the exact expected order:
    try {
      // 1) Start session: first call advances to asking_land_size
      await fetch(`${BACKEND_BASE}/chat?user_id=${encodeURIComponent(USER_ID)}`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message: "start" })
      });

      // 2) Send location (include pincode, state, district inside the message)
      const fullLocation = `${loc}, District: ${dist}, State: ${state}, Pincode: ${pin}`;
      await fetch(`${BACKEND_BASE}/chat?user_id=${encodeURIComponent(USER_ID)}`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message: fullLocation })
      });

      // 3) Land size
      await fetch(`${BACKEND_BASE}/chat?user_id=${encodeURIComponent(USER_ID)}`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message: land })
      });

      // 4) Budget
      await fetch(`${BACKEND_BASE}/chat?user_id=${encodeURIComponent(USER_ID)}`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message: `${budget} rupees` })
      });

      // 5) Age + Gender together (backend parses digits for age and finds "female" text)
      const age = calcAgeFromDOB(dob); // number
      const ageGenderMsg = `Age: ${age} Gender: ${gender}`;
      await fetch(`${BACKEND_BASE}/chat?user_id=${encodeURIComponent(USER_ID)}`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message: ageGenderMsg })
      });

      // 6) Current crops
      await fetch(`${BACKEND_BASE}/chat?user_id=${encodeURIComponent(USER_ID)}`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message: crops || "Not planned yet" })
      });

      toast("Profile saved âœ…");
      show("onboardingView", false);
      show("appView", true);
      initDashboard();
    } catch (err) {
      console.error(err);
      toast("Failed to complete onboarding.");
    }
  });

  function calcAgeFromDOB(dobStr){
    if (!dobStr) return "NA";
    const dob = new Date(dobStr);
    const now = new Date();
    let age = now.getFullYear() - dob.getFullYear();
    const m = now.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && now.getDate() < dob.getDate())) age--;
    return age;
    }

  // ================== DASHBOARD ==================
  async function initDashboard(){
    loadAlerts();
    loadSuggestions();
    bootChat();
  }

  // Alerts
  async function loadAlerts(){
    try {
      const res = await fetch(`${BACKEND_BASE}/alerts?user_id=${encodeURIComponent(USER_ID)}`);
      const data = await res.json();
      const box = document.getElementById("alertsBox");
      box.innerHTML = "";
      const arr = data?.data || [];
      if (!arr.length) {
        box.innerHTML = `<div class="text-muted">No alerts right now.</div>`;
        return;
      }
      arr.forEach(a => {
        const card = document.createElement("div");
        card.className = "alert alert-warning";
        const time = a.timestamp ? `<div class=\"small-muted\">${new Date(a.timestamp).toLocaleString()}</div>` : "";
        // Show suggestions as separate mini-cards (2-3)
        let sugBoxes = '';
        const suggestions = Array.isArray(a.suggestions) ? a.suggestions.slice(0,3) : (a.suggestion ? [a.suggestion] : []);
        suggestions.forEach(s=>{
          const txt = escapeHtml(String(s).replace(/^SUGGESTION:\s*/i,''));
          sugBoxes += `<div class=\"suggestion-card mt-2\">${txt}</div>`;
        });
        card.innerHTML = `<strong>${escapeHtml((a.alert||'Alert').replace(/^ALERT:\s*/i,''))}</strong>${sugBoxes}${time}`;
        box.appendChild(card);
      });
    } catch (e) {
      document.getElementById("alertsBox").innerHTML = `<div class="text-danger">Failed to load alerts.</div>`;
    }
  }

  // Suggestions
  const SUGG_SLOTS = [null, null, null];
  async function loadSuggestions(){
    const box = document.getElementById("suggBox");
    box.innerHTML = "";
    // Render 3 empty cards first
    for (let i=0;i<3;i++) {
      const card = document.createElement('div');
      card.id = `sugg_card_${i}`;
      card.className = 'suggestion-card d-flex align-items-start justify-content-between';
      card.innerHTML = `<div class="clamp-4" style="max-width:80%; color:#6b7280;">Loadingâ€¦</div>
        <div class="ms-2">
          <button class="btn btn-sm btn-success me-1" onclick="applySuggestionCard(${i})">âœ”</button>
          <button class="btn btn-sm btn-outline-danger" onclick="skipSuggestionCard(${i})">âœ–</button>
        </div>`;
      box.appendChild(card);
    }
    // Fill each slot with distinct categories
    await refillSuggestion(0, 'crop');
    await refillSuggestion(1, 'land');
    await refillSuggestion(2, 'budget');
  }

  async function refillSuggestion(i, category){
    try {
      const qs = category ? `&category=${encodeURIComponent(category)}` : '';
      const res = await fetch(`${BACKEND_BASE}/get-suggestion?user_id=${encodeURIComponent(USER_ID)}${qs}`);
      const data = await res.json();
      let text = Array.isArray(data?.suggestions) ? (data.suggestions[0]?.text || data.suggestions[0]) : (data?.suggestion || "");
      if (!text) text = "Stay hydrated and plan field work in cooler hours.";
      text = sanitizeText(String(text));
      SUGG_SLOTS[i] = { id: crypto.randomUUID(), text, category: category || null };
      renderSuggestionCard(i);
    } catch (e) {
      SUGG_SLOTS[i] = { id: crypto.randomUUID(), text: "Suggestion unavailable. Try again.", category: category || null };
      renderSuggestionCard(i);
    }
  }

  function renderSuggestionCard(i){
    const slot = SUGG_SLOTS[i];
    const card = document.getElementById(`sugg_card_${i}`);
    if (!card) return;
    const safe = escapeHtml(slot.text);
    card.innerHTML = `<div style="max-width:80%;">${safe}</div>
      <div class="ms-2">
        <button class="btn btn-sm btn-success me-1" onclick="applySuggestionCard(${i})">âœ”</button>
        <button class="btn btn-sm btn-outline-danger me-1" onclick="skipSuggestionCard(${i})">âœ–</button>
        <button class="btn btn-sm btn-outline-primary" onclick="askSuggestion(${i})"><i class="fa-solid fa-comment"></i> Ask</button>
      </div>`;
  }

  async function applySuggestionCard(i){
    // Best-effort mark applied; ignore failures
    try {
      await fetch(`${BACKEND_BASE}/apply-suggestion?user_id=${encodeURIComponent(USER_ID)}&suggestion_id=${encodeURIComponent(SUGG_SLOTS[i].id)}`, { method:"POST" });
    } catch {}
    // Immediately fetch a fresh suggestion for this slot
    await refillSuggestion(i, SUGG_SLOTS[i].category);
  }

  async function skipSuggestionCard(i){
    await refillSuggestion(i, SUGG_SLOTS[i].category);
  }

  // Copy suggestion into chat input so user can build a question around it
  function askSuggestion(i){
    const slot = SUGG_SLOTS[i];
    if (!slot) return;
    const input = document.getElementById('chatInput');
    const base = slot.text.trim();
    input.value = `${base} â€” Could you advise more on this? `;
    input.focus();
  }

  // Chat
  function bootChat(){
    const chatBox = document.getElementById("chatBox");
    chatBox.innerHTML = "";
    initVoice();
  }

  document.getElementById("chatForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const input = document.getElementById("chatInput");
    const text = input.value.trim();
    if (!text) return;
    
    // Clear input immediately to prevent double submission
    input.value = "";
    
    // Add user message
    appendMsg("me", text);

    try {
      const res = await fetch(`${BACKEND_BASE}/ask`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: USER_ID,
          query: text
        })
      });
      const data = await res.json();
      const ans = data?.answer || JSON.stringify(data);
      appendMsg("bot", ans);
    } catch (err) {
      console.error("Chat error:", err);
      appendMsg("bot", "Sorry, I encountered an error. Please try again.");
    }
  });

  // ====== Voice Recording, Whisper ASR, and TTS playback ======
  let mediaRecorder;
  let chunks = [];
  let isRecording = false;
  let voiceLang = 'en'; // default English

  function initVoice(){
    const recBtn = document.getElementById('recBtn');
    const recDot = document.getElementById('recDot');
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      recBtn.style.display = 'none';
      return;
    }

    recBtn.addEventListener('mousedown', startRecording);
    recBtn.addEventListener('touchstart', startRecording);
    window.addEventListener('mouseup', stopRecording);
    window.addEventListener('touchend', stopRecording);

    // Language toggle buttons
    const btnEn = document.getElementById('voiceLangEn');
    const btnHi = document.getElementById('voiceLangHi');
    function setLang(lang){
      voiceLang = lang;
      if (lang === 'en') { btnEn.classList.add('active'); btnHi.classList.remove('active'); }
      else { btnHi.classList.add('active'); btnEn.classList.remove('active'); }
    }
    btnEn.addEventListener('click', ()=> setLang('en'));
    btnHi.addEventListener('click', ()=> setLang('hi'));
    setLang('en');

    async function startRecording(){
      if (isRecording) return;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        chunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
        mediaRecorder.onstop = onRecordingStop;
        mediaRecorder.start();
        isRecording = true;
        recDot.style.display = '';
      } catch (e) {
        console.error('Mic error', e);
      }
    }

    async function stopRecording(){
      if (!isRecording) return;
      isRecording = false;
      recDot.style.display = 'none';
      try { mediaRecorder.stop(); } catch {}
    }

    async function onRecordingStop(){
      const blob = new Blob(chunks, { type: 'audio/webm' });
      chunks = [];
      const fd = new FormData();
      fd.append('file', blob, 'audio.webm');
      try {
        const resp = await fetch(`${BACKEND_BASE}/voice/ask?user_id=${encodeURIComponent(USER_ID)}&lang=${encodeURIComponent(voiceLang)}`, { method:'POST', body: fd });
        const js = await resp.json();
        const answer = js?.answer || 'No answer.';
        appendMsg('bot', answer);
        // Do not auto-play here; only add bot text. User can click Listen.
      } catch (e) {
        console.error('voice ask failed', e);
        appendMsg('bot', 'Voice query failed. Please try again.');
      }
    }
  }

  function appendMsg(who, text) {
    const box = document.getElementById("chatBox");
    const wrap = document.createElement("div");
    wrap.className = `msg ${who}`;

    // Render the message bubble
    const clean = sanitizeText(text);
    const html = renderMarkdown(clean);
    let avatar = who === 'bot' ? '<div class="avatar"><i class="fa-solid fa-robot"></i></div>' : '<div class="avatar"><i class="fa-solid fa-user"></i></div>';
    let bubbleHtml = `${avatar}<div class="bubble">${html}`;
    if (who === 'bot') {
      // Add a play button for TTS on demand
      bubbleHtml += ` <button class="btn btn-sm btn-outline-secondary" style="margin-left:6px;" onclick="playTTS(this)"><i class="fa-solid fa-volume-high"></i> Listen</button>`;
      bubbleHtml += ` <button class="btn btn-sm btn-outline-danger" onclick="stopTTS()"><i class="fa-solid fa-stop"></i> Stop</button>`;
    }
    bubbleHtml += `</div>`;
    wrap.innerHTML = bubbleHtml;
    box.appendChild(wrap);
    box.scrollTop = box.scrollHeight;
  }

  // TTS playback queue
  let audioQueue = [];
  let isPlaying = false;
  let currentAudio = null;

  function processQueue(){
    if (isPlaying || audioQueue.length === 0) return;
    const src = audioQueue.shift();
    isPlaying = true;
    currentAudio = new Audio(src);
    currentAudio.onended = () => {
      isPlaying = false;
      currentAudio = null;
      processQueue();
    };
    currentAudio.onerror = () => {
      isPlaying = false;
      currentAudio = null;
      processQueue();
    };
    currentAudio.play().catch(()=>{
      isPlaying = false;
      currentAudio = null;
      processQueue();
    });
  }

  function stopTTS(){
    try { if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; } } catch {}
    currentAudio = null;
    isPlaying = false;
    audioQueue = [];
  }

  async function playTTS(btn){
    try {
      // Find the bubble this button belongs to
      const bubble = btn.closest('.bubble');
      if (!bubble) return;
      // Clean markdown-like symbols for smoother speech and remove UI labels
      let fullText = sanitizeText(bubble.innerText.replace('Listen','').replace('Stop','')).trim();
      // Auto-detect language: use Hindi if Devanagari chars present
      const isHindi = /[\u0900-\u097F]/.test(fullText);
      const lang = isHindi ? 'hi' : 'en';
      const resp = await fetch(`${BACKEND_BASE}/tts`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text: fullText, language: lang })});
      const js = await resp.json();
      if (js?.audio_b64) {
        // Edge TTS returns MP3; enqueue and play sequentially
        const src = 'data:audio/mpeg;base64,' + js.audio_b64;
        audioQueue.push(src);
        processQueue();
      }
    } catch(e){ /* ignore */ }
  }

// Basic Markdown renderer for bold, italics, and tables
function renderMarkdown(md) {
  // bold **text**
  md = md.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
  // italics *text*
  md = md.replace(/\*(.*?)\*/g, "<i>$1</i>");

  // simple table support
  if (md.includes("|")) {
    const rows = md.trim().split("\n").filter(r => r.includes("|"));
    if (rows.length > 1) {
      let table = "<table border='1' cellspacing='0' cellpadding='5'>";
      rows.forEach((r, i) => {
        const cols = r.split("|").map(c => c.trim()).filter(c => c);
        table += "<tr>" + cols.map(c => `<td>${c}</td>`).join("") + "</tr>";
      });
      table += "</table>";
      return table;
    }
  }

  return md;
}


  // Remove asterisks, hashes and markdown-y symbols for display and TTS smoothness
  function sanitizeText(s){
    if (!s) return s;
    return s.replace(/[\*#`>]/g, "");
  }


  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", ()=>{
    clearSession();
    location.reload();
  });

  // If a prior session exists, try status and go straight to app or onboarding
  (async function boot(){
    if (!USER_ID) return;
    try {
      const st = await fetch(`${BACKEND_BASE}/status?user_id=${encodeURIComponent(USER_ID)}`).then(r=>r.json());
      if (st?.status === "profile_complete" || st?.status === "completed") {
        show("authView", false);
        show("appView", true);
        initDashboard();
      }
    } catch { /* ignore */ }
    // Footer year
    const yEl = document.getElementById('yr');
    if (yEl) yEl.textContent = new Date().getFullYear();
  })();
</script>
</body>
</html>
